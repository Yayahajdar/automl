{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load form_filters %}

{% block title %}Visualisation du fichier CSV{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="fil d'ariane">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Accueil</a></li>
                    <li class="breadcrumb-item active">{{ csv_file.title }}</li>
                </ol>
            </nav>

            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-0">{{ csv_file.title }}</h2>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-label="Menu d'exportation">
                                <i class="fas fa-download me-1"></i>Exporter
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'export_csv' csv_file.pk %}">Format CSV</a></li>
                                <li><a class="dropdown-item" href="{% url 'export_excel' csv_file.pk %}">Format Excel</a></li>
                                <li><a class="dropdown-item" href="{% url 'export_json' csv_file.pk %}">Format JSON</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0">Informations du fichier</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Nombre de lignes :</span>
                                            <span class="badge bg-primary">{{ summary.rows }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Nombre de colonnes :</span>
                                            <span class="badge bg-secondary">{{ summary.columns }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Cellules vides :</span>
                                            <span class="badge bg-warning">{{ summary.null_cells }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Lignes dupliqu√©es :</span>
                                            <span class="badge bg-info">{{ summary.duplicate_rows }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Taille du fichier :</span>
                                            <span class="badge bg-success">{{ summary.memory_usage }}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0">Actions disponibles</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <!-- AI Suggestions Section -->
                                        {% if request.GET.show_form == 'ai_suggest' %}
                                            <div class="card mb-2">
                                                <div class="card-header">
                                                    <h5 class="mb-0">üîÆ Suggestions IA</h5>
                                                </div>
                                                <div class="card-body">
                                                    {% if ai_suggestions %}
                                                        <div class="mb-3">
                                                            <h6>Recommandations :</h6>
                                                            <ul class="list-group">
                                                                {% for suggestion in ai_suggestions %}
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>{{ suggestion.reason }}</span>
                                                                        <span class="badge bg-info">{{ suggestion.action|title }}</span>
                                                                    </li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                        <form method="post" action="{% url 'apply_ai_suggestions' csv_file.pk %}">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-success">
                                                                <i class="fas fa-check-circle me-2"></i>Appliquer toutes
                                                            </button>
                                                            <a href="{% url 'view_csv' csv_file.pk %}" class="btn btn-secondary">
                                                                <i class="fas fa-times me-2"></i>Annuler
                                                            </a>
                                                        </form>
                                                    {% else %}
                                                        <form method="post" action="{% url 'ai_suggest_cleaning' csv_file.pk %}">
                                                            {% csrf_token %}
                                                            <p class="text-muted mb-3">Aucune suggestion disponible. Cliquez pour analyser.</p>
                                                            <button type="submit" class="btn btn-primary">
                                                                <i class="fas fa-robot me-2"></i>G√©n√©rer des suggestions
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% else %}
                                            <a href="?show_form=ai_suggest" class="btn btn-outline-info">
                                                <i class="fas fa-magic me-2"></i>Suggestions IA
                                            </a>
                                        {% endif %}

                                        <!-- Machine Learning Section -->
                                        {% if request.GET.show_form == 'ml' %}
                                            <div class="card mb-2">
                                                <div class="card-header">
                                                    <h5 class="mb-0">ü§ñ Entra√Ænement du Mod√®le ML</h5>
                                                </div>
                                                <div class="card-body">
                                                    <form method="post" action="{% url 'train_ml_model' csv_file.pk %}">
                                                        {% csrf_token %}
                                                        <div class="mb-3">
                                                            <label for="model_name" class="form-label">Nom du mod√®le</label>
                                                            <input type="text" class="form-control" name="model_name" id="model_name" required placeholder="Entrez un nom pour votre mod√®le">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="target" class="form-label">S√©lectionner la cible</label>
                                                            <select class="form-select" name="target" id="target" required>
                                                                <option value="" disabled selected>Choisissez la cible</option>
                                                                {% for col in columns %}
                                                                    <option value="{{ col }}">{{ col }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="features" class="form-label">S√©lectionner les caract√©ristiques</label>
                                                            <select class="form-select" name="features" id="features" multiple required>
                                                                {% for col in columns %}
                                                                    <option value="{{ col }}">{{ col }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="model_type" class="form-label">Type de mod√®le</label>
                                                            <select class="form-select" name="model_type" id="model_type" required>
                                                                <option value="regression">R√©gression</option>
                                                                <option value="classification">Classification</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="algorithm_type" class="form-label">Algorithme</label>
                                                            <select class="form-select" name="algorithm_type" id="algorithm_type" required>
                                                                <option value="random_forest">Random Forest</option>
                                                                <option value="decision_tree">Decision Tree</option>
                                                                <option value="linear">Linear/Logistic Regression</option>
                                                            </select>
                                                            <small class="form-text text-muted">
                                                                Pour la r√©gression: Linear Regression, Decision Tree, Random Forest<br>
                                                                Pour la classification: Logistic Regression, Decision Tree, Random Forest
                                                            </small>
                                                        </div>
                                                        <button type="submit" class="btn btn-success">
                                                            <i class="fas fa-play me-2"></i>Entra√Æner le mod√®le
                                                        </button>
                                                        <a href="{% url 'view_csv' csv_file.pk %}" class="btn btn-secondary">
                                                            <i class="fas fa-times me-2"></i>Annuler
                                                        </a>
                                                    </form>
                                                </div>
                                            </div>
                                        {% else %}
                                            <a href="?show_form=ml" class="btn btn-outline-success">
                                                <i class="fas fa-robot me-2"></i>Entra√Æner le mod√®le ML
                                            </a>
                                        {% endif %}

                                        <!-- Existing Action Forms -->
                                        {% if request.GET.show_form == 'clean' %}
                                            <form method="post" action="{% url 'clean_data' csv_file.pk %}" class="mb-2">
                                                {% csrf_token %}
                                                {{ cleaning_form|crispy }}
                                                <div class="d-flex gap-2">
                                                    <button type="submit" class="btn btn-primary flex-grow-1">
                                                        <i class="fas fa-check me-2"></i>Appliquer
                                                    </button>
                                                    <a href="{% url 'view_csv' csv_file.pk %}" class="btn btn-secondary">
                                                        <i class="fas fa-times me-2"></i>Annuler
                                                    </a>
                                                </div>
                                            </form>
                                        {% else %}
                                            <a href="?show_form=clean" class="btn btn-outline-primary">
                                                <i class="fas fa-broom me-2"></i>Nettoyer les donn√©es
                                            </a>
                                        {% endif %}

                                        {% if request.GET.show_form == 'column' %}
                                            <form method="post" action="{% url 'column_operation' csv_file.pk %}" class="mb-2">
                                                {% csrf_token %}
                                                {{ column_form|crispy }}
                                                <div class="d-flex gap-2">
                                                    <button type="submit" class="btn btn-primary flex-grow-1">
                                                        <i class="fas fa-check me-2"></i>Appliquer
                                                    </button>
                                                    <a href="{% url 'view_csv' csv_file.pk %}" class="btn btn-secondary">
                                                        <i class="fas fa-times me-2"></i>Annuler
                                                    </a>
                                                </div>
                                            </form>
                                        {% else %}
                                            <a href="?show_form=column" class="btn btn-outline-secondary">
                                                <i class="fas fa-columns me-2"></i>G√©rer les colonnes
                                            </a>
                                        {% endif %}

                                        {% if request.GET.show_form == 'delete_row' %}
                                            <form method="post" action="{% url 'delete_row' csv_file.pk %}" class="mb-2">
                                                {% csrf_token %}
                                                <div class="mb-3">
                                                    <label for="row_number" class="form-label">Num√©ro de ligne √† supprimer</label>
                                                    <input type="number" class="form-control" id="row_number" name="row_number" required min="0">
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button type="submit" class="btn btn-primary flex-grow-1">
                                                        <i class="fas fa-trash me-2"></i>Supprimer
                                                    </button>
                                                    <a href="{% url 'view_csv' csv_file.pk %}" class="btn btn-secondary">
                                                        <i class="fas fa-times me-2"></i>Annuler
                                                    </a>
                                                </div>
                                            </form>
                                        {% else %}
                                            <a href="?show_form=delete_row" class="btn btn-outline-danger">
                                                <i class="fas fa-trash me-2"></i>Supprimer une ligne
                                            </a>
                                        {% endif %}

                                        <form action="{% url 'delete_csv' csv_file.pk %}" method="post" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer ce fichier ? Cette action est irr√©versible.')" aria-label="Supprimer le fichier">
                                                <i class="fas fa-trash-alt me-2"></i>Supprimer le fichier
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation par onglets -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" data-bs-toggle="tab" href="#data" role="tab" aria-controls="data" aria-selected="true">
                                <i class="fas fa-table me-1"></i>Donn√©es
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="tab" href="#stats" role="tab" aria-controls="stats" aria-selected="false">
                                <i class="fas fa-chart-bar me-1"></i>Statistiques
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="tab" href="#visualizations" role="tab" aria-controls="visualizations" aria-selected="false">
                                <i class="fas fa-chart-line me-1"></i>Visualisations
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="tab" href="#history" role="tab" aria-controls="history" aria-selected="false">
                                <i class="fas fa-history me-1"></i>Historique
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="tab" href="#monitoring" role="tab" aria-controls="monitoring" aria-selected="false">
                                <i class="fas fa-chart-area me-1"></i>Monitoring
                            </a>
                        </li>
                    </ul>

                    <!-- Contenu des onglets -->
                    <div class="tab-content mt-3">
                        <!-- Onglet Donn√©es -->
                        <div class="tab-pane fade show active" id="data" role="tabpanel" aria-labelledby="data-tab">
                            <div class="table-responsive">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="text-muted">
                                        Affichage des lignes {{ pagination.start_index }} √† {{ pagination.end_index }} sur {{ pagination.total_rows }}
                                    </div>
                                </div>
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            {% for column in columns %}
                                            <th>{{ column }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in pagination.page.object_list %}
                                        <tr>
                                            {% for value in row %}
                                            <td>{{ value }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                                <!-- Pagination -->
                                {% if pagination.total_pages > 1 %}
                                <nav aria-label="Navigation des pages">
                                    <ul class="pagination justify-content-center">
                                        {% if pagination.page.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1" aria-label="Premi√®re page">
                                                <i class="fas fa-angle-double-left"></i>
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ pagination.page.previous_page_number }}" aria-label="Page pr√©c√©dente">
                                                <i class="fas fa-angle-left"></i>
                                            </a>
                                        </li>
                                        {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                                        </li>
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="fas fa-angle-left"></i></span>
                                        </li>
                                        {% endif %}

                                        <li class="page-item active">
                                            <span class="page-link">
                                                Page {{ pagination.page.number }} sur {{ pagination.total_pages }}
                                            </span>
                                        </li>

                                        {% if pagination.page.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ pagination.page.next_page_number }}" aria-label="Page suivante">
                                                <i class="fas fa-angle-right"></i>
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ pagination.total_pages }}" aria-label="Derni√®re page">
                                                <i class="fas fa-angle-double-right"></i>
                                            </a>
                                        </li>
                                        {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="fas fa-angle-right"></i></span>
                                        </li>
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Onglet Statistiques -->
                        <div class="tab-pane fade" id="stats">
                            <div class="row">
                                {% for col, stats in column_stats.items %}
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">{{ col }}</h5>
                                        </div>
                                        <div class="card-body">
                                            <dl class="row mb-0">
                                                {% for key, value in stats.items %}
                                                <dt class="col-sm-6">{{ key }}</dt>
                                                <dd class="col-sm-6">{{ value }}</dd>
                                                {% endfor %}
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Onglet Visualisations -->
                        <div class="tab-pane fade" id="visualizations" role="tabpanel" aria-labelledby="visualizations-tab">
                            <div class="row">
                                {% if plots %}
                                {% for plot in plots %}
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <div id="plot-{{ forloop.counter }}" class="plot-container"></div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="col-12">
                                    <p class="text-muted text-center">Aucune visualisation disponible</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Onglet Historique -->
                        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                            {% if operations_log %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th scope="col">Date et heure</th>
                                            <th scope="col">Type d'op√©ration</th>
                                            <th scope="col">D√©tails</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for operation in operations_log %}
                                        <tr>
                                            <td>{{ operation.timestamp|date:"d/m/Y H:i" }}</td>
                                            <td>{{ operation.type }}</td>
                                            <td>{{ operation.details }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Aucune op√©ration n'a encore √©t√© effectu√©e sur ce fichier.
                            </div>
                            {% endif %}
                        </div>

                        <!-- Onglet Monitoring -->
                        <div class="tab-pane fade" id="monitoring" role="tabpanel" aria-labelledby="monitoring-tab">
                            <div class="row">
                                <!-- Trained Models Section -->
                                <div class="col-12 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Mod√®les entra√Æn√©s</h5>
                                        </div>
                                        <div class="card-body">
                                            {% if trained_models %}
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Nom du mod√®le</th>
                                                                <th>Type</th>
                                                                <th>Score</th>
                                                                <th>Date d'entra√Ænement</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for model in trained_models %}
                                                            <tr>
                                                                <td>{{ model.name }}</td>
                                                                <td><span class="badge bg-info">{{ model.type }}</span></td>
                                                                <td>{{ model.score|floatformat:3 }}</td>
                                                                <td>{{ model.created_at|date:"d/m/Y H:i" }}</td>
                                                                <td>
                                                                    <div class="btn-group">
                                                                        <a href="{% url 'test_model' pk=csv_file.pk model_name=model.name %}"
                                                                           class="btn btn-sm btn-outline-primary">
                                                                            <i class="fas fa-vial me-1"></i>Tester
                                                                        </a>
                                                                        <a href="{% url 'model_actions' pk=csv_file.pk model_name=model.name %}"
                                                                           class="btn btn-sm btn-outline-secondary">
                                                                            <i class="fas fa-cog me-1"></i>G√©rer
                                                                        </a>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            {% else %}
                                                <p class="text-muted text-center">Aucun mod√®le entra√Æn√© pour le moment</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- System Performance Section -->
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Performance du syst√®me</h5>
                                            <button class="btn btn-sm btn-outline-secondary refresh-monitoring" title="Rafra√Æchir">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <div class="card-body" id="system-performance">
                                            <div class="mb-3">
                                                <h6>CPU Usage</h6>
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ cpu_usage }}%" aria-valuenow="{{ cpu_usage }}" aria-valuemin="0" aria-valuemax="100">{{ cpu_usage }}%</div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <h6>Memory Usage</h6>
                                                <div class="progress">
                                                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ memory_usage }}%" aria-valuenow="{{ memory_usage }}" aria-valuemin="0" aria-valuemax="100">{{ memory_usage }}%</div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <h6>Disk Usage</h6>
                                                <div class="progress">
                                                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ disk_usage }}%" aria-valuenow="{{ disk_usage }}" aria-valuemin="0" aria-valuemax="100">{{ disk_usage }}%</div>
                                                </div>
                                            </div>
                                            <div class="text-muted small text-end mt-2">
                                                Derni√®re mise √† jour: <span id="last-update">{{ last_update|default:"Jamais" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h5 class="mb-0">Statistiques d'utilisation</h5>
                                        </div>
                                        <div class="card-body" id="usage-stats">
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Temps de traitement moyen
                                                    <span class="badge bg-primary rounded-pill">{{ avg_processing_time }}ms</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Requ√™tes par minute
                                                    <span class="badge bg-success rounded-pill">{{ requests_per_minute }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Taille totale des fichiers
                                                    <span class="badge bg-info rounded-pill">{{ total_files_size }}</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Nombre total d'op√©rations
                                                    <span class="badge bg-secondary rounded-pill">{{ total_operations }}</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Graphique de performance</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="performance-chart" style="height: 300px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>



<script>
    document.addEventListener('DOMContentLoaded', function() {


        // Initialize data visualizations
        {% for plot in plots %}
            var plotData = JSON.parse('{{ plot|safe }}');
            Plotly.newPlot('plot-{{ forloop.counter }}', plotData.data, plotData.layout);
        {% endfor %}

        // Initialize performance chart
        const performanceData = {
            x: [],
            y: [],
            type: 'scatter',
            mode: 'lines',
            name: 'CPU Usage'
        };

        const layout = {
            title: 'System Performance Over Time',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Usage %' },
            margin: { t: 30 }
        };

        Plotly.newPlot('performance-chart', [performanceData], layout);

        // Monitoring refresh functionality
        function updateMonitoring() {
            fetch('{% url "get_monitoring_data" csv_file.pk %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Extract metrics from the nested structure
                    const systemMetrics = data.system_metrics;
                    const usageStats = data.usage_stats;

                    // Update system performance
                    document.querySelector('#system-performance .progress-bar').style.width = `${systemMetrics.cpu_usage}%`;
                    document.querySelector('#system-performance .progress-bar').textContent = `${systemMetrics.cpu_usage}%`;

                    document.querySelector('#system-performance .progress-bar.bg-info').style.width = `${systemMetrics.memory_usage.percent}%`;
                    document.querySelector('#system-performance .progress-bar.bg-info').textContent = `${systemMetrics.memory_usage.percent}%`;

                    document.querySelector('#system-performance .progress-bar.bg-warning').style.width = `${systemMetrics.disk_usage.percent}%`;
                    document.querySelector('#system-performance .progress-bar.bg-warning').textContent = `${systemMetrics.disk_usage.percent}%`;

                    // Update usage statistics if the elements exist
                    const usageStatsElement = document.getElementById('usage-stats');
                    if (usageStatsElement) {
                        const avgTimeElement = usageStatsElement.querySelector('.badge.bg-primary');
                        if (avgTimeElement) {
                            avgTimeElement.textContent = `${usageStats.avg_processing_time.toFixed(2)}ms`;
                        }

                        const requestsElement = usageStatsElement.querySelector('.badge.bg-success');
                        if (requestsElement) {
                            requestsElement.textContent = usageStats.requests_per_minute;
                        }

                        const filesSizeElement = usageStatsElement.querySelector('.badge.bg-info');
                        if (filesSizeElement) {
                            const size = usageStats.total_files_size;
                            const formattedSize = size > 1024 * 1024 ?
                                `${(size / (1024 * 1024)).toFixed(2)} MB` :
                                size > 1024 ?
                                    `${(size / 1024).toFixed(2)} KB` :
                                    `${size} B`;
                            filesSizeElement.textContent = formattedSize;
                        }

                        const operationsElement = usageStatsElement.querySelector('.badge.bg-secondary');
                        if (operationsElement) {
                            operationsElement.textContent = usageStats.total_operations;
                        }
                    }

                    // Update last update time
                    const lastUpdateElement = document.getElementById('last-update');
                    if (lastUpdateElement) {
                        lastUpdateElement.textContent = new Date().toLocaleTimeString();
                    }

                    // Update performance chart
                    const update = {
                        x: [[new Date().toLocaleTimeString()]],
                        y: [[systemMetrics.cpu_usage]]
                    };
                    Plotly.extendTraces('performance-chart', update, [0]);

                    // Keep only last 30 points
                    if (performanceData.x.length > 30) {
                        Plotly.relayout('performance-chart', {
                            xaxis: {
                                range: [performanceData.x[performanceData.x.length - 30], performanceData.x[performanceData.x.length - 1]]
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error updating monitoring data:', error);
                    // Show error notification to user
                    const errorElement = document.createElement('div');
                    errorElement.className = 'alert alert-danger alert-dismissible fade show';
                    errorElement.innerHTML = `
                        <strong>Error updating monitoring data:</strong> ${error.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;

                    // Add to the monitoring tab
                    const monitoringTab = document.getElementById('monitoring');
                    if (monitoringTab) {
                        // Remove any existing error alerts
                        const existingAlerts = monitoringTab.querySelectorAll('.alert-danger');
                        existingAlerts.forEach(alert => alert.remove());

                        // Add the new error alert at the top
                        monitoringTab.insertBefore(errorElement, monitoringTab.firstChild);
                    }
                });
        }

        // Initial update
        updateMonitoring();

        // Set up auto-refresh every 30 seconds
        const monitoringInterval = setInterval(updateMonitoring, 30000);

        // Manual refresh button
        document.querySelector('.refresh-monitoring').addEventListener('click', function() {
            this.classList.add('fa-spin');
            updateMonitoring();
            setTimeout(() => this.classList.remove('fa-spin'), 1000);
        });

        // Clean up interval when leaving the page
        window.addEventListener('beforeunload', function() {
            clearInterval(monitoringInterval);
        });
    });
</script>
{% endblock %}
