# Livrable E5 — Supervision et Gestion des Incidents (Projet AutoML/CSV Analyzer)

Ce livrable présente la stratégie de supervision, la définition des métriques, le dispositif d’alerting et une démonstration complète d’un incident simulé (reproduction, détection, alerte Discord, investigation et résolution), ainsi que les annexes techniques (PromQL, JSON d’alerte Grafana, commandes de vérification).

## Dossier des preuves (où trouver les captures)
- docsss/doc/img/01_app_running.svg — Application up
- docsss/doc/img/02_endpoint_simulated_error.svg — Endpoint d’erreur simulée
- docsss/doc/img/03_prometheus_target.svg — Cible Prometheus UP
- docsss/doc/img/04_promql_metric.svg — Requête PromQL et métrique incrémentée
- docsss/doc/img/05_grafana_rule.svg — Règle d’alerte Grafana
- docsss/doc/img/06_discord_webhook.svg — Contact point Discord
- docsss/doc/img/07_alert_firing.svg — Alerte en état Firing/Alerting
- docsss/doc/img/08_incident_issue.svg — Journal/trace de l’incident
- docsss/doc/img/09_fix_deploy.svg — Correctif et redéploiement
- docsss/doc/img/10_alert_resolved.svg — Alerte résolue

Chemins de code clés:
- Métrique Prometheus: csv_processor/metrics.py (Counter app_errors_total, label type)
- Endpoint d’erreur: csv_processor/views.py (simulate_error)
- Routage: csv_processor/urls.py (simulate-error/ et django_prometheus.urls)
- Prometheus: prometheus.yml (scrape_configs)

Commandes utiles (macOS):
- Lancer docker-compose (si utilisé): docker compose up -d
- Simuler l’erreur: curl -i http://localhost:8000/simulate-error/
- Vérifier métrique: curl -s http://localhost:8000/metrics | grep app_errors_total
- Ouvrir Prometheus: http://localhost:9090/
- Ouvrir Grafana: http://localhost:3000/

Table des matières
1. Préambule
2. Introduction
3. Supervision de l’application
   3.1 Métriques
   3.2 Seuils d’alerte
   3.3 Règles et flux d’alerting (Grafana → Discord)
   3.4 Solution de supervision
4. Résolution d’un incident technique (Cas pratique)
   4.1 Définition et périmètre
   4.2 Reproduction contrôlée d’un incident
   4.3 Détection par métriques et PromQL
   4.4 Règle d’alerte Grafana et notification Discord
   4.5 Investigation, correction et déploiement
   4.6 Post-mortem (mini REX)
5. Annexes techniques
   5.1 PromQL
   5.2 JSON d’alerte Grafana (à importer)
   5.3 Commandes rapides de vérification

## 1. Préambule
Ce document suit l’exigence de démontrer la chaîne complète: incident reproduit, métrique incrémentée, détection Prometheus, alerte Grafana vers Discord, puis résolution et retour à la normale.

## 2. Introduction
Le projet AutoML/CSV Analyzer est une application Django permettant de téléverser et manipuler des CSV, d’entraîner des modèles (classification/régression), et de suivre des métriques système et applicatives. La supervision repose sur:
- Export d’un endpoint /metrics (django_prometheus et métriques personnalisées)
- Prometheus (scraping)
- Grafana (dashboards + alerting)
- Discord (canal d’incidents)

Architecture (simplifiée):
- Django (web) expose /metrics
- Prometheus scrape les métriques
- Grafana lit Prometheus, alerte via webhook Discord

## 3. Supervision de l’application

### 3.1 Métriques
- app_errors_total{type} (Counter) — Nombre d’erreurs applicatives, label type pour catégoriser, défini dans csv_processor/metrics.py.
- Métriques exposées par django_prometheus (requêtes, latences, HTTP 5xx, etc.).
- Optionnel: métriques CPU/RAM de la machine si node_exporter est activé.

### 3.2 Seuils d’alerte (exemples)
- Erreurs simulées: increase(app_errors_total{type="simulated"}[5m]) > 0
- Erreurs HTTP 5xx: increase(django_http_requests_total_by_status_total{status=~"5.."}[5m]) > 5
- Disponibilité: up{job="web"} == 0 pendant 1m

### 3.3 Règles et flux d’alerting
- Grafana Alert Rule évalue les PromQL ci-dessus
- Notification Policy → Contact point Discord (Webhook)
- Labels: service="csv_analyzer", severity in {"warning","critical"}

### 3.4 Solution de supervision
- Prometheus: prometheus.yml contient la cible (web) sur /metrics
- Grafana: dashboard dédié (grafana/dashboards/*.json)
- Discord: créer un webhook et remplacer l’URL dans le JSON d’alerte fourni

## 4. Résolution d’un incident technique (Cas pratique)

### 4.1 Définition et périmètre
Incident démontré: le service renvoie des 500 sur l’endpoint de test /simulate-error/ afin de vérifier la chaîne de détection et d’alerte.

### 4.2 Reproduction contrôlée
1) Lancer l’application (docker compose up -d) — preuve: 01_app_running.svg
2) Appeler plusieurs fois:
   curl -i http://localhost:8000/simulate-error/
   → Retour 500 et incrément du compteur — preuve: 02_endpoint_simulated_error.svg

Rappels techniques:
- csv_processor/views.py: simulate_error incrémente APP_ERRORS_TOTAL.labels(type="simulated").inc() et renvoie 500
- csv_processor/urls.py: path('simulate-error/', views.simulate_error, ...)

### 4.3 Détection par métriques et PromQL
- Prometheus cible UP — preuve: 03_prometheus_target.svg
- Vérifier la métrique:
  - PromQL: increase(app_errors_total{type="simulated"}[5m])
  - Via curl: curl -s http://localhost:8000/metrics | grep app_errors_total
— preuve: 04_promql_metric.svg

### 4.4 Règle d’alerte Grafana et notification Discord
- Importer le JSON d’alerte fourni (cf. Annexes 5.2), remplacer l’URL Discord
- La règle passe en Alerting dès qu’une erreur simulée est observée
— preuves:
  - 05_grafana_rule.svg (règle)
  - 06_discord_webhook.svg (contact point)
  - 07_alert_firing.svg (alerte reçue dans Discord)

### 4.5 Investigation, correction et déploiement
- Exemples d’investigation: journaux/gunicorn, redémarrage du service web, vérification du routage
— preuve: 08_incident_issue.svg
- Correctif et redéploiement: docker compose restart web (ou reload), vérifier retour à la normale
— preuve: 09_fix_deploy.svg
- Métrique se stabilise, l’alerte se résout
— preuve: 10_alert_resolved.svg

### 4.6 Post-mortem (mini REX)
- Cause: endpoint de test renvoyant 500
- Détection: Prometheus + règle Grafana
- Impact: test contrôlé (aucun utilisateur affecté)
- Actions: validation chaîne d’alerte, documentation, tableau de bord
- Prévention: alerte séparée pour HTTP 5xx réels, playbook d’incident, tests de fumée CI

## 5. Annexes techniques

### 5.1 PromQL
- Erreurs simulées:
  increase(app_errors_total{type="simulated"}[5m]) > 0
- 5xx globaux:
  increase(django_http_requests_total_by_status_total{status=~"5.."}[5m]) > 5
- Disponibilité cible:
  up{job="web"} == 0

### 5.2 JSON d’alerte Grafana
Fichier: grafana/alerts/discord_app_errors_rule.json
- Remplacer DISCORD_WEBHOOK_URL par votre webhook
- Import via l’API Grafana (ou UI si supportée)

### 5.3 Commandes rapides
- Simuler erreur:
  curl -i http://localhost:8000/simulate-error/
- Vérifier métrique:
  curl -s http://localhost:8000/metrics | grep app_errors_total
- Ouvrir Prometheus: http://localhost:9090/
- Ouvrir Grafana: http://localhost:3000/

Fin du document.